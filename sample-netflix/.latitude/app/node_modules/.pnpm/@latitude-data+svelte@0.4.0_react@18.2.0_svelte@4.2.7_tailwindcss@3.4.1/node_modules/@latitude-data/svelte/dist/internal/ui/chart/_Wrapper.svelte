<script context="module"></script>

<script>import { theme as client } from "@latitude-data/client";
const { cn } = client.utils;
import BlankSlate from "./_BlankSlate.svelte";
import Error from "./_Error.svelte";
import * as Card from "../../../ui/card";
export let data = null;
export let isLoading = false;
export let height = void 0;
export let width = void 0;
export let title = void 0;
export let description = void 0;
export let error = null;
export let bordered = false;
const cardStyle = bordered ? "normal" : "invisible";
function getPadding(element, side) {
  const cs = getComputedStyle(element);
  const padding = side === "top" ? cs?.paddingTop : cs?.paddingBottom;
  return parseFloat(padding);
}
function calculateHeight(element) {
  return element.clientHeight + getPadding(element, "top") + getPadding(element, "bottom");
}
$:
  dataset = {
    fields: data?.fields ? data.fields.map((f) => f.name) : [],
    source: data?.rows ?? []
  };
let headerHeight = 0;
$:
  contentPaddingTop = 0;
$:
  contentPaddingBottom = 0;
function cardHeaderDimensions(element) {
  headerHeight = calculateHeight(element);
  const resizeObserver = new ResizeObserver(() => {
    headerHeight = calculateHeight(element);
  });
  return {
    destroy() {
      resizeObserver.unobserve(element);
    }
  };
}
function cardContentDimensions(element) {
  contentPaddingTop = getPadding(element, "top");
  contentPaddingBottom = getPadding(element, "bottom");
  const resizeObserver = new ResizeObserver(() => {
    contentPaddingTop = getPadding(element, "top");
    contentPaddingBottom = getPadding(element, "bottom");
  });
  return {
    destroy() {
      resizeObserver.unobserve(element);
    }
  };
}
$:
  contentHeight = height;
$: {
  if (title) {
    contentHeight = height ? height + contentPaddingTop + contentPaddingBottom - headerHeight : height;
  } else {
    contentHeight = height ? height - contentPaddingTop - contentPaddingBottom - headerHeight : height;
  }
}
</script>

<div
  class={cn('relative h-full w-full', { 'animate-pulse': isLoading })}
  style="width: {width}px; height: {height}px"
>
  <Card.Root class="h-full" type={cardStyle}>
    {#if title}
      <Card.Header type={cardStyle} action={cardHeaderDimensions}>
        <Card.Title>{title}</Card.Title>
        {#if description}
          <Card.Description>{description}</Card.Description>
        {/if}
      </Card.Header>
    {/if}

    <Card.Content
      type={cardStyle}
      action={cardContentDimensions}
      style="height: {contentHeight}px;"
    >
      {#if error}
        <Error {error} />
      {:else if !data || (!data && isLoading)}
        <BlankSlate {isLoading} />
      {:else}
        <slot {dataset} {contentHeight} />
      {/if}
    </Card.Content>
  </Card.Root>
</div>
