<script context="module">import { RichDate, RELATIVE_DATES, RelativeDate } from "@latitude-data/custom_types";
</script>

<script>import { Calendar as CalendarIcon, LightningBolt as LightningBoltIcon } from "radix-icons-svelte";
import { DateFormatter, fromDate, getLocalTimeZone } from "@internationalized/date";
import { Button, Calendar, Popover, Select, ToggleGroup } from "../..";
import { theme } from "@latitude-data/client";
import { writable } from "svelte/store";
import { createEventDispatcher } from "svelte";
export let lang = "en-US";
export let dateStyle = "long";
export let value = new RichDate(RelativeDate.Today);
export let onValueChange = () => {
};
let className = "";
export { className as class };
const df = new DateFormatter(lang, { dateStyle });
const dispatch = createEventDispatcher();
const val = writable(value);
function setValue(newValue) {
  val.set(newValue);
  onValueChange(newValue);
  dispatch("change", newValue);
}
$:
  isRelative = $val.isRelative();
let isSelectorOpen = false;
let isCalendarOpen = false;
var ToggleValue = /* @__PURE__ */ ((ToggleValue2) => {
  ToggleValue2["Relative"] = "relative";
  ToggleValue2["Absolute"] = "absolute";
  return ToggleValue2;
})(ToggleValue || {});
$:
  toggleValue = isRelative ? "relative" /* Relative */ : "absolute" /* Absolute */;
function onToggleChange(value2) {
  if (Array.isArray(value2))
    return;
  if (!value2 || value2 === toggleValue)
    return;
  if (value2 === "relative" /* Relative */) {
    setValue(new RichDate(RelativeDate.Today));
  } else {
    setValue(new RichDate($val.resolve()));
  }
  isSelectorOpen = value2 === "relative" /* Relative */;
  isCalendarOpen = !isSelectorOpen;
}
const selectorItems = Object.entries(RELATIVE_DATES).map(([key, value2]) => {
  return { value: value2, label: key };
});
function onSelectChange(selected) {
  if (!selected?.value || !Object.values(RelativeDate).includes(selected.value)) {
    return;
  }
  setValue(new RichDate(selected.value));
}
function relativeDateLabel(value2) {
  return Object.entries(RELATIVE_DATES).find(([_, v]) => v === value2)?.[0] ?? "";
}
$:
  selectorValue = {
    label: isRelative ? relativeDateLabel($val.value) : void 0,
    value: isRelative ? $val.value : void 0
  };
function onDateChange(dateValue) {
  if (!dateValue)
    return;
  const date = dateValue.toDate(getLocalTimeZone());
  setValue(new RichDate(date));
}
$:
  calendarLabel = df.format($val.resolve());
$:
  calendarValue = fromDate($val.resolve(), getLocalTimeZone());
</script>

<div class={theme.ui.datePicker.cssClass({ className })}>
  {#if isRelative}
    <Select.Root
      items={selectorItems}
      selected={selectorValue}
      onSelectedChange={onSelectChange}
      bind:open={isSelectorOpen}
    >
      <Select.Trigger class={theme.ui.datePicker.selectCssClass({ isRange: false })}>
        <Select.Value placeholder="Select Date" />
      </Select.Trigger>
      <Select.Content>
        {#each selectorItems as item}
          <Select.Item value={item.value}>{item.label}</Select.Item>
        {/each}
      </Select.Content>
    </Select.Root>
  {:else}
    <Popover.Root openFocus bind:open={isCalendarOpen}>
      <Popover.Trigger asChild let:builder>
        <Button
          variant="outline"
          class={theme.ui.datePicker.buttonCssClass({ isRange: false })}}
          builders={[builder]}
        >
          {calendarLabel}
        </Button>
      </Popover.Trigger>
      <Popover.Content class={theme.ui.datePicker.POPOVER_CONTENT_CSS_CLASS}>
        <Calendar onValueChange={onDateChange} value={calendarValue} />
      </Popover.Content>
    </Popover.Root>
  {/if}
  <ToggleGroup.Root type="single" value={toggleValue} onValueChange={onToggleChange} class={theme.ui.datePicker.TOGGLE_GROUP_CSS_CLASS}>
    <ToggleGroup.Item value={ToggleValue.Relative} class={theme.ui.datePicker.TOGGLE_BUTTON_CSS_CLASS}>
      <LightningBoltIcon class={theme.ui.datePicker.TOGGLE_ICON_CSS_CLASS} aria-label="Relative" />
    </ToggleGroup.Item>
    <ToggleGroup.Item value={ToggleValue.Absolute} class={theme.ui.datePicker.TOGGLE_BUTTON_CSS_CLASS}>
      <CalendarIcon class={theme.ui.datePicker.TOGGLE_ICON_CSS_CLASS} aria-label="Absolute" />
    </ToggleGroup.Item>
  </ToggleGroup.Root>
</div>
